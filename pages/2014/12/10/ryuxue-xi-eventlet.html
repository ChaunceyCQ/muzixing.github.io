<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>Milestone</title>
    <meta name="description" content="">
    <meta name="author" content="muzi">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="../../../../theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="../../../../theme/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="../../../../theme/local.css" rel="stylesheet">
    <link href="../../../../theme/pygments.css" rel="stylesheet">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="../../../..">Milestone</a>

        <div class="nav-collapse">

        <ul class="nav">
            
            <li><a href="../../../../pages/about-me.html">About me</a></li>
        </ul>
	<form class="navbar-search pull-right" action="/search.html">
    	<input type="text" class="search-query" placeholder="Search" name="q" id="s">
</form>

        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
    <div class='article'>
        <div class="content-title">
            <h1>RYU学习:eventlet</h1>
2014-12-10

by <a class="url fn" href="../../../../author/muzi.html">muzi</a>
 


        </div>
	
        <div><h2>前言</h2>
<p>从OpenDaylight转到RYU以来一直都没有机会好好学习RYU的源码,只学会了编写简单的Application。但是如果要熟悉一个控制器，就要熟悉它的运行原理，熟悉它数据结构，熟悉它的设计模式等等。最近终于有时间好好看RYU的代码，但在看代码的过程中却发现RYU并不简单，其编码风格也非常优雅，非常值得学习。本篇博文主要讲述RYU中使用到的eventlet。</p>
<h2>从RYU开始</h2>
<p>运行ryu的时候，命令是：ryu-manager app.py。第一个要找到就是ryu-manager到底会触发什么程序。在/cmd中没有找到之后，在/bin中找到了两个可执行文件：ryu和ryu-manager。打开ryu-manager，显示如下：</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">ryu</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">manager</span> <span class="nb">import</span> <span class="n">main</span>
<span class="n">main</span><span class="p">()</span>
</pre></div>


<p>找到/ryu/cmd/manager.py，发现这个文件中的main()函数是整个ryu的入口函数。</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="n">None</span><span class="p">):</span>
    <span class="n">try:</span>
        <span class="n">CONF</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span>
             <span class="n">project</span><span class="o">=</span><span class="s">&#39;ryu&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&#39;ryu-manager %s&#39;</span> <span class="nv">%</span> <span class="nv">version</span><span class="p">,</span>
             <span class="n">default_config_files</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;/usr/local/etc/ryu/ryu.conf&#39;</span><span class="p">])</span>
    <span class="n">except</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ConfigFilesNotFoundError:</span>
        <span class="n">CONF</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span>
             <span class="n">project</span><span class="o">=</span><span class="s">&#39;ryu&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&#39;ryu-manager %s&#39;</span> <span class="nv">%</span> <span class="nv">version</span><span class="p">)</span>

    <span class="nb">log</span><span class="o">.</span><span class="n">init_log</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">CONF</span><span class="o">.</span><span class="n">pid_file:</span>
        <span class="nb">import</span> <span class="n">os</span>
        <span class="n">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CONF</span><span class="o">.</span><span class="n">pid_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">pid_file:</span>
            <span class="n">pid_file</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>

    <span class="n">app_lists</span> <span class="o">=</span> <span class="n">CONF</span><span class="o">.</span><span class="n">app_lists</span> <span class="o">+</span> <span class="n">CONF</span><span class="o">.</span><span class="n">app</span>
    <span class="c1"># keep old behaivor, run ofp if no application is specified.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app_lists:</span>
        <span class="n">app_lists</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ryu.controller.ofp_handler&#39;</span><span class="p">]</span>

    <span class="n">app_mgr</span> <span class="o">=</span> <span class="n">AppManager</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
    <span class="n">app_mgr</span><span class="o">.</span><span class="n">load_apps</span><span class="p">(</span><span class="n">app_lists</span><span class="p">)</span>
    <span class="n">contexts</span> <span class="o">=</span> <span class="n">app_mgr</span><span class="o">.</span><span class="n">create_contexts</span><span class="p">()</span>
    <span class="n">services</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">services</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">app_mgr</span><span class="o">.</span><span class="n">instantiate_apps</span><span class="p">(</span><span class="o">**</span><span class="n">contexts</span><span class="p">))</span>

    <span class="n">webapp</span> <span class="o">=</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">start_service</span><span class="p">(</span><span class="n">app_mgr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">webapp:</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">webapp</span><span class="p">)</span>
        <span class="n">services</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thr</span><span class="p">)</span>

    <span class="n">try:</span>
        <span class="n">hub</span><span class="o">.</span><span class="n">joinall</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
    <span class="n">finally:</span>
        <span class="n">app_mgr</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
</pre></div>


<p>这个main()函数的内容主要是完成了RYU的初始化配置和启动。Configure使用了oslo，这个在后续的博文中应该会提到。初始化的构成主要包括将app_list里面的内容加入App_Manager的列表中，然后开启协程去协调这些APP完成工作。hub是from ryu.lib import hub的。继续查看ryu/lib/hub.py。最终找到许多关于eventlet的内容。在hub.py中定义了Event,StreamServer和WSGIServer等类，还有一些重要的重要函数如spawn()等。为了更好地学习RYU，学习coroutine和eventlet就非常有必要了。</p>
<h2><a href="http://en.wikipedia.org/wiki/Coroutine#Implementations_for_Python">Coroutine</a></h2>
<p>协程[coroutine]是一个程序组件。相比subroutine, coroutine更一般。coroutine相对与thread而言，又不一样。thread是资源抢占式的存在，而coroutine是通过yield来转移执行权，协程之间是平等的，没有等级关系。multi-thread一旦开始运行，就无法确定某一时刻到底是哪一个thread在占用cpu，临界资源也要加互斥锁。而coroutine则是需要程序员自己决定程序如何运行，同时也需要自己负责程序的风险。协程和线程一样，只共享堆，不共享栈。</p>
<h2><a href="http://eventlet.net/">Eventlet</a></h2>
<p>eventlet是一个可以提供高性能并发处理能力的python库。我们可以在/usr/lib/python2.7/dist-packages/eventlet中找到对应的文件。</p>
<h3>Installation</h3>
<div class="highlight"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">eventlet</span>
</pre></div>


<h3>Examples</h3>
<p>为了更好的理解eventlet的内容，我花了半天认真地抄了一遍<a href="http://eventlet.net/doc/examples.html">官网</a>的例子。具体实例举例如下。</p>
<p><strong>GreenPile</strong></p>
<div class="highlight"><pre><span class="s">&quot;&quot;&quot;Spawn multiple workers and collect their results.</span>

<span class="s">Demonstrates how to use the eventlet.green.socket module.</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="nb">import</span> <span class="n">eventlet</span>
<span class="n">from</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">green</span> <span class="nb">import</span> <span class="nb">socket</span>


<span class="n">def</span> <span class="n">geturl</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">con</span> <span class="o">=</span> <span class="nb">socket</span><span class="o">.</span><span class="nb">socket</span><span class="p">()</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="nb">socket</span><span class="o">.</span><span class="nb">gethostbyname</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">con</span><span class="o">.</span><span class="nb">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;%s connected&#39;</span> <span class="nv">%</span> <span class="nv">url</span><span class="p">)</span>
    <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">&#39;GET /\r\n\r\n&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">con</span><span class="o">.</span><span class="nb">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>


<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;www.muzixing.com&#39;</span><span class="p">,</span> <span class="s">&#39;www.baidu.com&#39;</span><span class="p">,</span> <span class="s">&#39;www.python.org&#39;</span><span class="p">]</span>
<span class="n">pile</span> <span class="o">=</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">GreenPile</span><span class="p">()</span>
<span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">urls:</span>
    <span class="n">pile</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">geturl</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">result</span> <span class="n">in</span> <span class="n">zip</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">pile</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;%s: %s&#39;</span> <span class="nv">%</span> <span class="err">(</span><span class="nv">url</span><span class="p">,</span> <span class="n">repr</span><span class="p">(</span><span class="n">result</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]))</span>
</pre></div>


<p>以上的代码对指定url发送了GET请求。重点在与eventlet.GreenPile()的使用。GreenPile类源码如下所示：</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">GreenPile</span><span class="p">(</span><span class="n">object</span><span class="p">):</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">size_or_pool</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">size_or_pool</span><span class="p">,</span> <span class="n">GreenPool</span><span class="p">):</span>
            <span class="n">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">size_or_pool</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">GreenPool</span><span class="p">(</span><span class="n">size_or_pool</span><span class="p">)</span>
        <span class="n">self</span><span class="o">.</span><span class="n">waiters</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">LightQueue</span><span class="p">()</span>
        <span class="n">self</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="n">False</span>
        <span class="n">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">def</span> <span class="n">spawn</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="s">&quot;&quot;&quot;Runs *func* in its own green thread, with the result available by</span>
<span class="s">        iterating over the GreenPile object.&quot;&quot;&quot;</span>
        <span class="n">self</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span>  <span class="n">True</span>
        <span class="n">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">try:</span>
            <span class="ow">gt</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">self</span><span class="o">.</span><span class="n">waiters</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="ow">gt</span><span class="p">)</span>
        <span class="n">except:</span>
            <span class="n">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">raise</span>

    <span class="n">def</span> <span class="n">__iter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span>

    <span class="n">def</span> <span class="k">next</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="s">&quot;&quot;&quot;Wait for the next result, suspending the current greenthread until it</span>
<span class="s">        is available.  Raises StopIteration when there are no more results.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">self</span><span class="o">.</span><span class="n">used:</span>
            <span class="n">raise</span> <span class="n">StopIteration</span><span class="p">()</span>
        <span class="n">try:</span>
            <span class="k">return</span> <span class="n">self</span><span class="o">.</span><span class="n">waiters</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="nb">wait</span><span class="p">()</span>
        <span class="n">finally:</span>
            <span class="n">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">-=</span> <span class="mi">1</span>
</pre></div>


<p>从__init__函数可以看出，GreenPile内部有一个GreenPool对象和一个Queue对象：waiters。GreenPool的作用相当与线程池的作用，这点后续会继续介绍。上述例子用到的spawn函数完成了协程（被称之为green thread）的启动。可以看出spawn函数的参数是（函数，参数），在上述例子中为： pile.spawn(geturl, x)。从spawn函数中，也可以看出spawn()方法的返回值被保存在waiters队列中。next()方法的实现使其具有迭代性质。</p>
<p><strong>GreenPool</strong></p>
<p>下面的例子使用到了GreenPool类，完成了一个非常暴力的迭代爬虫，理论上，如果你让他去爬取某一个网站，然后不去管它，它会从这个网站出发，找到所有的链接，然后跳到各自的链接，然后继续迭代，直到最后把整个互联网的网站都爬一遍。而且，它不尊重你网站的robot.txt，这意味这它什么都会爬取。</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">__future__</span> <span class="nb">import</span> <span class="n">with_statement</span>
<span class="n">from</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">green</span> <span class="nb">import</span> <span class="n">urllib2</span>
<span class="nb">import</span> <span class="n">eventlet</span>
<span class="nb">import</span> <span class="n">re</span>


<span class="c1"># http://daringfireball.net/2009/11/liberal_regex_for_matching_urls</span>
<span class="n">url_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">r</span><span class="s">&#39;\b(([\w-]+://?|www[.])[^\s()&lt;&gt;]+(?:\([\w\d]+\)|([^[:punct:]\s]|/)))&#39;</span><span class="p">)</span>


<span class="n">def</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
    <span class="s">&#39;&#39;&#39;Fetch A url, stick any found urls into the seen set,</span>
<span class="s">    and dispatch any new  ones to te pool.&#39;&#39;&#39;</span>
    <span class="k">print</span> <span class="s">&quot;fetching&quot;</span><span class="p">,</span> <span class="n">url</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">with</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">False</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="nb">read</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">url_match</span> <span class="n">in</span> <span class="n">url_regex</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">new_url</span> <span class="o">=</span> <span class="n">url_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># You can only send requests to muzixing.com so as not to destroy internet</span>
        <span class="k">if</span> <span class="n">new_url</span> <span class="ow">not</span> <span class="n">in</span> <span class="n">seen:</span>  <span class="c1"># and ’muzixing.com&#39; in new_url:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_url</span><span class="p">)</span>
            <span class="c1"># While this seems stack-recursive, it is actually not.</span>
            <span class="c1"># Spawned greenthreads start their own stacks</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">spawn_n</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="n">new_url</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">pool</span><span class="p">)</span>


<span class="n">def</span> <span class="n">crawl</span><span class="p">(</span><span class="n">start_url</span><span class="p">):</span>
    <span class="s">&#39;&#39;&#39;Recrusively crawl starting from *start_url*.Return a set of</span>
<span class="s">    urls that were found.</span>
<span class="s">    &#39;&#39;&#39;</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">GreenPool</span><span class="p">()</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="n">set</span><span class="p">()</span>
    <span class="n">fetch</span><span class="p">(</span><span class="n">start_url</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">pool</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">waitall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">seen</span>

<span class="n">seen</span> <span class="o">=</span> <span class="n">crawl</span><span class="p">(</span><span class="s">&quot;http://www.muzixing.com&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;I saw there urls:&quot;</span><span class="p">,</span> <span class="n">seen</span>
<span class="c1"># print &#39;\n&#39;.join(seen)</span>
</pre></div>


<p>首先爬虫从<a href="http://www.muzixing.com">http://www.muzixing.com</a>网站开始搜索url。然后继续迭代寻找url，不断扩大查找范围。实验结果如下所示：</p>
<p><img alt="" src="http://ww4.sinaimg.cn/mw690/7f593341jw1en5uqubim7j20m10n1dn9.jpg" /></p>
<p>图1：迭代爬虫显示信息</p>
<p>从上图可以看到爬虫抓取了<a href="http://www.muzixing.com">www.muzixing.com</a>的网页中存在的url如<a href="http://ikimi.net">http://ikimi.net</a>，然后我们可以看到爬虫又跳到了<a href="http://ikimi.net">http://ikimi.net</a>上爬取页面的其他url,如<a href="http://www.ikimi.net/wp-includes">http://www.ikimi.net/wp-includes</a>。如果将起始页面换成<a href="bbs.byr.cn">bbs.byr.cn</a>会发现爬虫会以更快的速度在整个互联网蔓延开来！</p>
<p>上述例子中可以学习到GreenPool类的使用。GreenPool可以类比于线程池，这有利于理解。在GreenPool中的元素都是GreenThread。其中最重要的函数是spawn/spawn_n函数。</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">spawn</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="s">&quot;&quot;&quot;Run the *function* with its arguments in its own green thread.</span>
<span class="s">        Returns the :class:`GreenThread &lt;eventlet.greenthread.GreenThread&gt;`</span>
<span class="s">        object that is running the function, which can be used to retrieve the</span>
<span class="s">        results.</span>
<span class="s">&quot;&quot;&quot;</span>
</pre></div>


<p>该函数启动了一个GreenThread，参数是需要执行的function和function对应的参数。返回值是执行该函数的GreenThread类。</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">spawn_n</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">&quot;&quot;&quot;Create a greenthread to run the *function*, the same as</span>
<span class="s">        :meth:`spawn`.  The difference is that :meth:`spawn_n` returns</span>
<span class="s">        None; the results of *function* are not retrievable.</span>
<span class="s">        &quot;&quot;&quot;</span>
</pre></div>


<p>spawn_n函数功能上差不多，只是返回的是None。其他的函数举例简单说明如下：</p>
<ul>
<li>
<p>waitall():等待所有greenthread执行完毕。</p>
</li>
<li>
<p>running(): 返回目前正在执行的greenthread。</p>
</li>
<li>
<p>imap():从迭代器中取出数据項作为func的参数去执行，并返回结果。</p>
</li>
<li>
<p>starmap(): 和imap类似，但是取参数的方式有所差异。从<a href="http://blog.csdn.net/hackerain/article/details/7836993">openstack nova 基础知识——eventlet</a>中摘取举例如下：</p>
<div class="highlight"><pre><span class="n">imap</span><span class="p">(</span><span class="n">pow</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">--&gt;</span> <span class="mi">32</span> <span class="mi">9</span> <span class="mi">1000</span>
<span class="n">starmap</span><span class="p">(</span><span class="n">pow</span><span class="p">,</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">)])</span> <span class="o">--&gt;</span> <span class="mi">32</span> <span class="mi">9</span> <span class="mi">1000</span>
</pre></div>


</li>
<li>
<p>free(): 返回当前可获取的greenthread的数目。</p>
</li>
</ul>
<p>以上代码上的with语句是python中的一个非常方便的关键字。使用with关键字可以让代码更严谨且简洁。其封装了__enter__()函数和__exit__()函数，用于执行信息和退出处理。其等价于以下代码：</p>
<div class="highlight"><pre><span class="err">try:</span>
    <span class="err">__enter__()</span>
<span class="err">finally:</span>
    <span class="err">__exit__()</span>
</pre></div>


<p>上述是关于GreenPool类的使用案例，使用该类可以高效完成并发操作。</p>
<p><strong>Convenience</strong></p>
<p>接下来再介绍一个更好玩的程序，多人群聊程序，可以让我们在学习eventlet的时候充满成就感。代码如下：</p>
<div class="highlight"><pre><span class="nb">import</span> <span class="n">eventlet</span>
<span class="n">from</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">green</span> <span class="nb">import</span> <span class="nb">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">3001</span>
<span class="n">participants</span> <span class="o">=</span> <span class="n">set</span><span class="p">()</span>


<span class="n">def</span> <span class="n">read_chat_forever</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="nb">readline</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">line:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Chat:&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">p</span> <span class="n">in</span> <span class="n">participants:</span>
            <span class="n">try:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">writer:</span>  <span class="c1"># Don&#39;t echo</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="n">line</span>
                    <span class="n">p</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">except</span> <span class="nb">socket</span><span class="o">.</span><span class="n">error</span> <span class="n">as</span> <span class="n">e:</span>
                <span class="c1"># ignore broken pipes, they just mean the participant</span>
                <span class="c1"># closed its connection already</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="n">raise</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="nb">readline</span><span class="p">()</span>
    <span class="n">participants</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;participant left chat&quot;</span><span class="p">)</span>


<span class="n">try:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;ChatServer starting up on port %s&quot;</span> <span class="nv">%</span> <span class="nv">PORT</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">eventlet</span><span class="o">.</span><span class="nb">listen</span><span class="p">((</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">True:</span>
        <span class="n">new_connection</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="nb">accept</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Participant joined chat.&quot;</span><span class="p">)</span>
        <span class="n">new_writer</span> <span class="o">=</span> <span class="n">new_connection</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">participants</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_writer</span><span class="p">)</span>
        <span class="n">eventlet</span><span class="o">.</span><span class="n">spawn_n</span><span class="p">(</span>
            <span class="n">read_chat_forever</span><span class="p">,</span>
            <span class="n">new_writer</span><span class="p">,</span>
            <span class="n">new_connection</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">),</span>
            <span class="n">address</span><span class="p">)</span>
<span class="n">except</span> <span class="p">(</span><span class="n">KeyboardInterrupt</span><span class="p">,</span> <span class="n">SystemExit</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;ChatServer exiting&quot;</span><span class="p">)</span>
</pre></div>


<p>try语句块中完成了服务端socket的建立和监听。然后在while循环中完成了消息的处理。</p>
<p>首先关注第一个函数：eventlet.listen((addr,port))。在eventlet文件夹中，打开__init__文件可以查看到一些为了方便而初始化的定义，举例如下：</p>
<div class="highlight"><pre><span class="n">version_info</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span><span class="o">.</span><span class="nb">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">version_info</span><span class="p">))</span>

<span class="n">try:</span>
    <span class="n">from</span> <span class="n">eventlet</span> <span class="nb">import</span> <span class="n">greenthread</span>
    <span class="n">from</span> <span class="n">eventlet</span> <span class="nb">import</span> <span class="n">greenpool</span>
    <span class="n">from</span> <span class="n">eventlet</span> <span class="nb">import</span> <span class="n">queue</span>
    <span class="n">from</span> <span class="n">eventlet</span> <span class="nb">import</span> <span class="n">timeout</span>
    <span class="n">from</span> <span class="n">eventlet</span> <span class="nb">import</span> <span class="n">patcher</span>
    <span class="n">from</span> <span class="n">eventlet</span> <span class="nb">import</span> <span class="n">convenience</span>
    <span class="nb">import</span> <span class="n">greenlet</span>



    <span class="n">GreenPool</span> <span class="o">=</span> <span class="n">greenpool</span><span class="o">.</span><span class="n">GreenPool</span>
    <span class="n">GreenPile</span> <span class="o">=</span> <span class="n">greenpool</span><span class="o">.</span><span class="n">GreenPile</span>

    <span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span>

    <span class="n">import_patched</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">import_patched</span>
    <span class="n">monkey_patch</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">monkey_patch</span>

    <span class="nb">connect</span> <span class="o">=</span> <span class="n">convenience</span><span class="o">.</span><span class="nb">connect</span>
    <span class="nb">listen</span> <span class="o">=</span> <span class="n">convenience</span><span class="o">.</span><span class="nb">listen</span>
    <span class="n">serve</span> <span class="o">=</span> <span class="n">convenience</span><span class="o">.</span><span class="n">serve</span>
    <span class="n">StopServe</span> <span class="o">=</span> <span class="n">convenience</span><span class="o">.</span><span class="n">StopServe</span>
    <span class="n">wrap_ssl</span> <span class="o">=</span> <span class="n">convenience</span><span class="o">.</span><span class="n">wrap_ssl</span>
</pre></div>


<p>所以我们直接可以使用eventlet.listen调用convenience.listen函数。listen函数完成了一个server socket的绑定和监听。</p>
<div class="highlight"><pre><span class="n">def</span> <span class="nb">listen</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="nb">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">backlog</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="nb">socket</span><span class="o">.</span><span class="nb">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="nb">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;win&quot;</span><span class="p">:</span>
        <span class="n">sock</span><span class="o">.</span><span class="nb">setsockopt</span><span class="p">(</span><span class="nb">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="nb">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="nb">bind</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="nb">listen</span><span class="p">(</span><span class="n">backlog</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sock</span>
</pre></div>


<p>socket.accept()函数将返回一个（connection，address）元组。socket.makefile([mode[, bufsize]])返回一个文件对象用于读写缓存。</p>
<p>eventlet.spawn_n函数将read_chat_forever函数及其三个参数作为参数，创建GreenThread去执行任务。eventlet主要完成的工作就是帮助你如何去协调你的任务，而不是去实现你的任务，这一点在这里得到体现。其实对比于线程池就容易理解读多了。</p>
<p>试验结果截图如下：</p>
<p><img alt="" src="http://ww1.sinaimg.cn/mw690/7f593341jw1en5tcjidm2j20gt0crabx.jpg" /></p>
<p>图2：多人群聊server运行界面</p>
<p><img alt="" src="http://ww4.sinaimg.cn/mw690/7f593341jw1en5tcj7dvej20ln0crwh8.jpg" /></p>
<p>图3：多人群聊client运行界面</p>
<p>从client运行界面可以看出不同的用户发送的信息会以IP：message的形式展示出来，代码很简单，但是非常有趣。</p>
<p>以上例子均可以在官网找到，读者可以到官网去查看更多案例。</p>
<p><strong>Patcher</strong></p>
<p>Patch是eventlet中的一个重要模块。用于替换系统自带的模块。其中有import_patched和monkey_patch两个函数，后者可以提供运行时替换。具体例子可以查看<a href="http://blog.csdn.net/hackerain/article/details/7836993">openstack nova 基础知识——eventlet</a></p>
<h2>回到RYU</h2>
<p>前两行代码调用了hub.patch()函数，查看hub.py中发现patch = eventlet.monkey_patch，实现了运行时替换模块。</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">ryu</span><span class="o">.</span><span class="n">lib</span> <span class="nb">import</span> <span class="n">hub</span>
<span class="n">hub</span><span class="o">.</span><span class="n">patch</span><span class="p">()</span>
</pre></div>


<p>接下来的CONF文件由于oslo的内容比较多，所以会在后续博文中详细介绍。首先关注main()函数的主要内容。</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="n">None</span><span class="p">):</span>
    <span class="n">try:</span>
        <span class="n">CONF</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span>
             <span class="n">project</span><span class="o">=</span><span class="s">&#39;ryu&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&#39;ryu-manager %s&#39;</span> <span class="nv">%</span> <span class="nv">version</span><span class="p">,</span>
             <span class="n">default_config_files</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;/usr/local/etc/ryu/ryu.conf&#39;</span><span class="p">])</span>
    <span class="n">except</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ConfigFilesNotFoundError:</span>
        <span class="n">CONF</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span>
             <span class="n">project</span><span class="o">=</span><span class="s">&#39;ryu&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&#39;ryu-manager %s&#39;</span> <span class="nv">%</span> <span class="nv">version</span><span class="p">)</span>

    <span class="nb">log</span><span class="o">.</span><span class="n">init_log</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">CONF</span><span class="o">.</span><span class="n">pid_file:</span>
        <span class="nb">import</span> <span class="n">os</span>
        <span class="n">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CONF</span><span class="o">.</span><span class="n">pid_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">pid_file:</span>
            <span class="n">pid_file</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>

    <span class="n">app_lists</span> <span class="o">=</span> <span class="n">CONF</span><span class="o">.</span><span class="n">app_lists</span> <span class="o">+</span> <span class="n">CONF</span><span class="o">.</span><span class="n">app</span>
    <span class="c1"># keep old behaivor, run ofp if no application is specified.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app_lists:</span>
        <span class="n">app_lists</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ryu.controller.ofp_handler&#39;</span><span class="p">]</span>

    <span class="n">app_mgr</span> <span class="o">=</span> <span class="n">AppManager</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
    <span class="n">app_mgr</span><span class="o">.</span><span class="n">load_apps</span><span class="p">(</span><span class="n">app_lists</span><span class="p">)</span>
    <span class="n">contexts</span> <span class="o">=</span> <span class="n">app_mgr</span><span class="o">.</span><span class="n">create_contexts</span><span class="p">()</span>
    <span class="n">services</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">services</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">app_mgr</span><span class="o">.</span><span class="n">instantiate_apps</span><span class="p">(</span><span class="o">**</span><span class="n">contexts</span><span class="p">))</span>

    <span class="n">webapp</span> <span class="o">=</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">start_service</span><span class="p">(</span><span class="n">app_mgr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">webapp:</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">webapp</span><span class="p">)</span>
        <span class="n">services</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thr</span><span class="p">)</span>

    <span class="n">try:</span>
        <span class="n">hub</span><span class="o">.</span><span class="n">joinall</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
    <span class="n">finally:</span>
        <span class="n">app_mgr</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
</pre></div>


<p>从CONF文件中取出app信息，存在app_lists内，若没有启动其他app,则默认启动ofp_handler应用，用于处理基础的事件，如协议协商等。然后声明一个AppManager的类，用于初始化和管理APP。load_apps函数完成了APP的加载。最后try语句块中的joinall()使得进程需要等待所有的services完成之后才能退出。至此RYU初始运行学习完成，后续的博文将分别介绍：oslo, 事件处理机制，RYUAPP类以及RYU数据结构和API使用等内容。</p>
<h2>后语</h2>
<p>Evenlet是个不错的python库，简单却很高效。相比于thread,coroutine的行为是可控的，切换成本也要更小。在单核情况下，coroutine要比thread开销小，但是multithread可以在多CPU的情况下发挥更大的能力。RYU是使用Python编写的控制器，比同样使用Python编写的POX，无论从代码的规范，优雅度，还是从性能上，都有很大的优势，此外，这个纯SDN控制器对OpenFlow协议的支持可以说是最稳定，最全面的。虽然我还会继续研究ONOS，学习大型分布式框架。但是RYU会成为我开发Application的利器。相比之下，Java编写的ODL，过于复杂和不稳定。新生儿ONOS相比之下用户体验更好，且没有使用YANG，大大降低了学习难度。周一的时候，还在Docker中安装了ONOS，并使用Cbench测试对比了ONOS和RYU的吞吐量。同样环境下，单节点的ONOS性能几乎是RYU的两倍，这让我有些忧伤。也许匕首只适合敏捷作战，而大刀才是开疆扩土的利器吧。</p></div>
	
        <hr>
    	   
        <h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'muzixinggithubio'; 
    var disqus_title = 'RYU学习:eventlet';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="../../../../archives.html">Archives</a>
                <li><a href="../../../../tags.html">Tags</a>
                <li><a href="http://www.muzixing.com/" rel="alternate">Atom feed</a></li>
                <li><a href="http://www.muzixing.com/feeds/all.rss.xml" rel="alternate">RSS feed</a></li>
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="../../../../category/life.html">life</a></li>
                <li><a href="../../../../category/tech.html">Tech</a></li>
                   
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                <li><a href="http://www.sdnlab.com/">SDNLAB</a></li>
                <li><a href="http://www.sdnap.com/">SDNAP</a></li>
                <li><a href="http://www.richardzhao.me/">Richardzhao</a></li>
                <li><a href="http://ikimi.net/">Kimi Yang</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="https://github.com/muzixing">github</a></li>
                <li><a href="http://350959853.qzone.qq.com">qzone</a></li>
                <li><a href="http://weibo.com/u/2136552257">weibo</a></li>
                <li><a href="http://linkedin.com/profile/view?id=334725834">Linkedin</a></li>
            </ul>
            </div>
            </div>

        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="../../../..">Milestone</a> &copy; muzi 2012</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
<script>var _gaq=[['_setAccount','UA-45955656-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
 
</body>
</html>